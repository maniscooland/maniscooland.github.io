<!DOCTYPE html>
<html>
<head>
    <title>Top-down Battle Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        class Vehicle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 120;
                this.height = 80;
                this.speed = 3;
                this.rotation = 0;
                this.driver = null;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x + this.width/2, this.y + this.height/2);
                ctx.rotate(this.rotation);
                ctx.translate(-this.width/2, -this.height/2);
                
                // Car body
                ctx.fillStyle = '#666';
                ctx.fillRect(0, 0, this.width, this.height);
                
                // Wheels
                ctx.fillStyle = '#333';
                ctx.fillRect(-5, -5, 20, 20);
                ctx.fillRect(this.width - 15, -5, 20, 20);
                ctx.fillRect(-5, this.height - 15, 20, 20);
                ctx.fillRect(this.width - 15, this.height - 15, 20, 20);
                
                // Side-by-side Seats
                ctx.fillStyle = '#444';
                ctx.fillRect(45, 10, 25, 25);  // Left seat
                ctx.fillRect(45, 45, 25, 25);  // Right seat
                
                // Driver
                if (this.driver) {
                    ctx.save();
                    ctx.translate(57, 22);
                    ctx.rotate(this.rotation * -1 + Math.PI/2);
                    
                    ctx.beginPath();
                    ctx.arc(0, 0, 12, 0, Math.PI * 2);
                    ctx.fillStyle = this.driver.color;
                    ctx.fill();
                    
                    ctx.fillRect(15, -10, 8, 8);
                    ctx.fillRect(15, 2, 8, 8);
                    
                    ctx.restore();
                }
                
                ctx.restore();
            }

            update() {
                if (this.driver) {
                    // Keep vehicle in bounds
                    this.x = Math.max(0, Math.min(canvas.width - this.width, this.x));
                    this.y = Math.max(0, Math.min(canvas.height - this.height, this.y));
                }
            }
        }

        class Player {
            constructor(x, y, isAI = false) {
                this.x = x;
                this.y = y;
                this.rotation = 0;
                this.speed = 5;
                this.isAI = isAI;
                this.color = isAI ? 'red' : 'blue';
                this.vehicle = null;
                this.state = 'wandering';
                this.targetX = x;
                this.targetY = y;
                this.stateTimer = 0;
            }

            draw() {
                if (this.vehicle) return;
                
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                
                ctx.beginPath();
                ctx.arc(0, 0, 20, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                
                ctx.fillRect(15, -10, 10, 10);
                ctx.fillRect(15, 0, 10, 10);
                
                ctx.restore();
            }

            findNearestVehicle(vehicles) {
                return vehicles.find(v => !v.driver && 
                    Math.hypot(v.x - this.x, v.y - this.y) < 200);
            }

            setNewTarget() {
                this.targetX = Math.random() * canvas.width;
                this.targetY = Math.random() * canvas.height;
            }

            update(vehicles) {
                if (!this.isAI) {
                    if (!this.vehicle) {
                        if (keys.w) this.y -= this.speed;
                        if (keys.s) this.y += this.speed;
                        if (keys.a) this.x -= this.speed;
                        if (keys.d) this.x += this.speed;
                        
                        const dx = mouseX - this.x;
                        const dy = mouseY - this.y;
                        this.rotation = Math.atan2(dy, dx) + Math.PI/2;

                        if (keys.e) {
                            vehicles.forEach(v => {
                                if (!v.driver && Math.hypot(v.x + v.width/2 - this.x, v.y + v.height/2 - this.y) < 50) {
                                    this.vehicle = v;
                                    v.driver = this;
                                }
                            });
                        }
                    } else {
                        if (keys.w) {
                            this.vehicle.x += Math.cos(this.vehicle.rotation) * this.vehicle.speed;
                            this.vehicle.y += Math.sin(this.vehicle.rotation) * this.vehicle.speed;
                        }
                        if (keys.s) {
                            this.vehicle.x -= Math.cos(this.vehicle.rotation) * this.vehicle.speed;
                            this.vehicle.y -= Math.sin(this.vehicle.rotation) * this.vehicle.speed;
                        }
                        if (keys.a) this.vehicle.rotation -= 0.05;
                        if (keys.d) this.vehicle.rotation += 0.05;
                        
                        if (keys.e) {
                            this.vehicle.driver = null;
                            this.vehicle = null;
                        }
                    }
                } else {
                    this.stateTimer++;

                    switch(this.state) {
                        case 'wandering':
                            if (!this.vehicle) {
                                if (this.stateTimer > 100) {
                                    this.setNewTarget();
                                    this.stateTimer = 0;
                                }
                                
                                const dx = this.targetX - this.x;
                                const dy = this.targetY - this.y;
                                this.rotation = Math.atan2(dy, dx) + Math.PI/2;
                                this.x += Math.cos(this.rotation - Math.PI/2) * this.speed;
                                this.y += Math.sin(this.rotation - Math.PI/2) * this.speed;

                                const nearestVehicle = this.findNearestVehicle(vehicles);
                                if (nearestVehicle) {
                                    this.state = 'seeking_vehicle';
                                    this.targetX = nearestVehicle.x;
                                    this.targetY = nearestVehicle.y;
                                }
                            }
                            break;

                        case 'seeking_vehicle':
                            const dx = this.targetX - this.x;
                            const dy = this.targetY - this.y;
                            this.rotation = Math.atan2(dy, dx) + Math.PI/2;
                            this.x += Math.cos(this.rotation - Math.PI/2) * this.speed;
                            this.y += Math.sin(this.rotation - Math.PI/2) * this.speed;

                            vehicles.forEach(v => {
                                if (!v.driver && Math.hypot(v.x - this.x, v.y - this.y) < 50) {
                                    this.vehicle = v;
                                    v.driver = this;
                                    this.state = 'driving';
                                }
                            });
                            break;

                        case 'driving':
                            if (this.vehicle) {
                                if (this.stateTimer > 300) {
                                    this.vehicle.driver = null;
                                    this.vehicle = null;
                                    this.state = 'wandering';
                                    this.stateTimer = 0;
                                    this.setNewTarget();
                                } else {
                                    if (this.stateTimer % 100 === 0) {
                                        this.targetX = Math.random() * canvas.width;
                                        this.targetY = Math.random() * canvas.height;
                                    }
                                    
                                    const dx = this.targetX - this.vehicle.x;
                                    const dy = this.targetY - this.vehicle.y;
                                    const targetAngle = Math.atan2(dy, dx);
                                    
                                    let angleDiff = targetAngle - this.vehicle.rotation;
                                    if (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
                                    if (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
                                    
                                    this.vehicle.rotation += angleDiff * 0.1;
                                    this.vehicle.x += Math.cos(this.vehicle.rotation) * this.vehicle.speed;
                                    this.vehicle.y += Math.sin(this.vehicle.rotation) * this.vehicle.speed;
                                }
                            }
                            break;
                    }
                }
            }
        }

        const player = new Player(window.innerWidth/2, window.innerHeight/2);
        const vehicles = Array(5).fill().map(() => new Vehicle(
            Math.random() * (canvas.width - 200),
            Math.random() * (canvas.height - 200)
        ));
        const aiPlayers = Array(10).fill().map(() => new Player(
            Math.random() * canvas.width,
            Math.random() * canvas.height,
            true
        ));

        const keys = {
            w: false,
            s: false,
            a: false,
            d: false,
            e: false
        };
        let mouseX = 0;
        let mouseY = 0;

        window.addEventListener('keydown', e => keys[e.key] = true);
        window.addEventListener('keyup', e => keys[e.key] = false);
        window.addEventListener('mousemove', e => {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            vehicles.forEach(vehicle => {
                vehicle.update();
                vehicle.draw();
            });
            
            aiPlayers.forEach(ai => {
                ai.update(vehicles);
                ai.draw();
            });
            
            player.update(vehicles);
            player.draw();
            
            requestAnimationFrame(gameLoop);
        }

        gameLoop();
    </script>
</body>
</html>
